name: CI/CD Pipeline - Olist Lakehouse

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # 1. Baixa o cÃ³digo do repositÃ³rio
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. Configura Python
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. --- O PULO DO GATO --- Configura JAVA (ObrigatÃ³rio para PySpark)
    - name: Set up Java (OpenJDK 11)
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'

    # 4. Instala dependÃªncias
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        # Instala dependÃªncias do projeto
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        # Instala dependÃªncias de Teste e Qualidade
        pip install pytest pytest-mock ruff pyspark

    # 5. Roda os Testes (Com PYTHONPATH configurado)
    - name: ðŸ§ª Run Unit Tests
      env:
        # Isso garante que o Python encontre o mÃ³dulo 'src'
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "ðŸš€ Iniciando bateria de testes..."
        pytest tests/ -v

    # 6. Verifica qualidade do cÃ³digo (Substituindo Pylint por Ruff)
    - name: âš¡ Lint with Ruff
      run: |
        # Verifica a pasta src buscando erros de padrÃ£o e imports inÃºteis
        ruff check src/